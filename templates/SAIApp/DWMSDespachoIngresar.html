{% extends 'base.html' %}
{% block content %}
    {% if user.is_authenticated %}
        <div class="page-header">
            <h2>Ingresar Despacho</h2>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Datos del Despacho</h3>
            </div>
            <div class="panel-body">
                <form method="POST" action="{% url 'SAIApp:DWMSDespachoIngresar' %}" id="postForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_transporte" class="control-label">{{ form.transporte.label }}</label>
                        {{ form.transporte }}
                    </div>
                    <div class="form-group hidden" id="otro_transporte_field">
                        <label for="id_otro_transporte" class="control-label">{{ form.otro_transporte.label }}</label>
                        {{ form.otro_transporte }}
                    </div>
                    <div class="form-group">
                        <label for="id_fecha_despacho"
                               class="control-label">{{ form.fecha_despacho.label }}</label>
                        {{ form.fecha_despacho }}
                    </div>
                    <div class="form-group">
                        <label for="id_nota" class="control-label">{{ form.nota.label }}</label>
                        {{ form.nota }}
                    </div>
                    <div class="form-group">
                        <label for="filepond" class="control-label">Fotos</label>
                        <input type="file"
                               class="filepond"
                               name="filepond"
                               id="filepond"
                               multiple
                                {% comment %}
                           data-allow-reorder="true"
                           data-max-file-size="3MB"
                           data-max-files="3"
                           {% endcomment %}
                               accept="image/*,application/pdf"/>
                    </div>

                    {% if form.errors %}
                        {% for field in form %}
                            {% for error in field.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    {{ error|escape }}
                                </div>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <div class="alert alert-danger alert-dismissible" role="alert">
                                {{ error|escape }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <a class="btn btn-default btn-lg" href="{% url 'SAIApp:DWMSDespacho' %}"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>&nbsp Atrás</a>
                    <button type="submit" id="saveBtn" class="btn btn-primary btn-lg" style="float: right;"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>&nbsp Guardar</button>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            const transformedFilesMap = new Map();
            function getLocalTimestamp() {
                const now = new Date();
                const pad = (n) => String(n).padStart(2, '0');

                const year = now.getFullYear();
                const month = pad(now.getMonth() + 1);
                const day = pad(now.getDate());
                const hours = pad(now.getHours());
                const minutes = pad(now.getMinutes());
                const seconds = pad(now.getSeconds());

                return `${year}${month}${day}${hours}${minutes}${seconds}`;
            }

            function* filenameGenerator() {
                let counter = 0;
                const timestamp = getLocalTimestamp();

                while (true) {
                    yield `${timestamp}_${counter}`;
                    counter++;
                }
            }

            const getFilename = filenameGenerator();

            document.addEventListener('FilePond:preparefile', (e) => {
                console.log("Archivo preparado", e.detail);
            });

            document.addEventListener('DOMContentLoaded', function () {
                // Otro transporte
                const transporteSelect = document.getElementById('id_transporte');
                const otroField = document.getElementById('id_otro_transporte').closest('.form-group');
                const otroInput = document.getElementById('id_otro_transporte');

                function toggleOtroField() {
                    const selectedText = transporteSelect.options[transporteSelect.selectedIndex].text;
                    if (selectedText.trim().toUpperCase() === 'OTRO') {
                        otroField.classList.remove('hidden');
                        otroInput.focus()
                    } else {
                        otroField.classList.add('hidden');
                        document.getElementById('id_otro_transporte').value = ''; // clear when hidden
                    }
                }

                transporteSelect.addEventListener('change', toggleOtroField);
                toggleOtroField();

                FilePond.registerPlugin(
                    FilePondPluginFileRename,
                    FilePondPluginFileValidateType,
                    FilePondPluginImagePreview,
                    FilePondPluginImageResize,
                    FilePondPluginImageTransform,
                );

                FilePond.setOptions({
                    server: null,
                    allowMultiple: true,
                    maxFiles: 3,
                    credits: false,
                    dropOnPage: true,
                    dropOnElement: true,
                })
                const inputElement = document.querySelector('input[type="file"]');
                const pond = FilePond.create(inputElement, {
                    acceptedFileTypes: ['image/*'],
                    labelFileTypeNotAllowed: 'Formato de archivo inválido. Ingrese fotos o imágenes.',
                    // Resize before upload
                    imageResizeTargetWidth: 1280,
                    imageResizeTargetHeight: 1280,
                    imageResizeMode: 'contain',
                    imageResizeUpscale: "false",
                    // Compression
                    //allowImageTransform: true,
                    //imageTransformVariantsIncludeDefault: false,
                    //imageTransformOutputQuality: 90,
                    imageTransformOutputMimeType: 'image/jpeg', // force to JPEG
                    fileRenameFunction: (file) => {
                        const newFilename = getFilename.next().value;
                        return `${newFilename}${file.extension}`;
                    },
                    onremovefile: (err, file) => {
                        transformedFilesMap.delete(file.id);
                    },
                    onpreparefile: (file, output) => {
                        const outputFile = new File([output], output.name, {type: output.type});
                        transformedFilesMap.set(file.id, outputFile);
                    }

                });
                const form = document.getElementById('postForm');
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    let formData = new FormData(form);

                    pond.getFiles().forEach((fileItem) =>{
                        const transformed = transformedFilesMap.get(fileItem.id);
                        formData.append('filepond', transformed);
                    })

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                window.location.href = "{% url 'SAIApp:DWMSDespacho' %}";
                            } else {
                                return response.text().then(text => {
                                    console.error('Error:', text);
                                    alert("There was an error: " + text);
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Unexpected error:', error);
                        });
                });
            });
        </script>

    {% endif %}
{% endblock %}
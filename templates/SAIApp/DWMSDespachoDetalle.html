{% extends 'base.html' %}
{% load static %}
{% if user.is_authenticated %}
    {% block content %}
        <div class="page-header">
            <h2>Detalles Despacho</h2>
        </div>
        <div class="row">
            <div class="col-md-7">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Datos del Despacho</h3>
                    </div>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <h6 class="list-group-item-heading">Transporte</h6>
                                <small class="list-group-item-text">{{ despacho.transporte }}</small>
                            {% if despacho.transporte.nombre == 'OTRO' %}
                                <small class="list-group-item-text">- {{ despacho.otro_transporte }}</small>
                            {% endif %}
                        </li>
                        <li class="list-group-item">
                            <h6 class="list-group-item-heading">Fecha despacho</h6>
                            <small class="list-group-item-text">{{ despacho.fecha_despacho }}</small>
                        </li>
                        {% if despacho.nota %}
                            <li class="list-group-item">
                                <h6 class="list-group-item-heading">Notas</h6>
                                <small class="list-group-item-text text-body-secondary">{{ despacho.nota }}</small>
                            </li>
                        {% endif %}
                        <li class="list-group-item">
                            <h6 class="list-group-item-heading">Creación</h6>
                            <small class="list-group-item-text">{{ despacho.fecha_creacion }} por {{ despacho.creacion_user }}</small>
                        </li>
                        <li class="list-group-item">
                            <h6 class="list-group-item-heading">Modificación</h6>
                            <small class="list-group-item-text ">{{ despacho.fecha_modificacion }} por {{ despacho.mod_user }}</small>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-5">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Guías Asociadas</h3>
                        </div>
                        <ul class="list-group">
                            {% for guia in guias %}
                                <li class="list-group-item lh-sm" id="guia_{{ guia.id }}">
                                    <div class="pull-left">
                                        <h6>{{ guia.guia_header.folio }}</h6>
                                    </div>
                                    <div class="pull-right">
                                        <button data-id="{{ guia.id }}" class="btn btn-danger delete-guia">
                                            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                        </button>
                                        <a href="{% url 'SAIApp:DWMSDespachoEditarGuia' guia.pk %}" role="button" class="btn btn-warning">
                                            <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                        </a>
                                        <a href="{% url 'SAIApp:DWMSDespachoVerGuia' guia.pk %}" role="button" class="btn btn-default">
                                            <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                                        </a>
                                    </div>
                                    <div class="clearfix"></div>
                                </li>
                            {% endfor %}
                            <li class="list-group-item">
                                <a class="btn btn-primary btn-block" role="button" href="{% url 'SAIApp:DWMSDespachoAgregarGuia' despacho.pk %}"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span>&nbsp Agregar guía</a>
                            </li>
                        </ul>
                    </div>
                </div>
        </div>
        {% if fotos %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Fotos del despacho</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        {% for foto in fotos %}
                            <div class="col-sm-6 col-md-4">
                                <button class="thumbnail foto-thumbnail" data-toggle="modal" data-target="#fotoModal" data-url="{{ foto.foto.url }}">
                                    <img src="{{ foto.foto.url }}" alt="banana">
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="fotoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-body text-center">
                            <img src="" alt="Foto despacho" class="img-responsive">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <a class="btn btn-default btn-lg" href="{% url 'SAIApp:DWMSDespacho' %}"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>&nbsp Atrás</a>
    {% endblock %}

    {% block script %}
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() {
                var modal = document.getElementById('fotoModal');
                var modalImg = modal.querySelector('.modal-body img');

                var thumbnails = document.querySelectorAll('.foto-thumbnail');

                thumbnails.forEach(function(button) {
                    button.addEventListener('click', function() {
                        var url = button.getAttribute('data-url');
                        modalImg.setAttribute('src', url);
                    });
                });

                document.querySelectorAll(".delete-guia").forEach(button => {
                    button.addEventListener("click", async function () {
                        let guiaId = this.getAttribute("data-id");
                        let guiaDiv = document.getElementById(`guia_${guiaId}`);

                        if (!confirm("¿Desea eliminar esta guía?")) return;

                        try {
                            let response = await fetch(`/SAIApp/DWMSDespachoEliminarGuia/${guiaId}`, {
                                method: "POST",
                                headers: {
                                    "X-CSRFToken": "{{ csrf_token }}",
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({})
                            });

                            console.log(response)
                            let result = await response.json();
                            console.log(result)
                            if (result.success) {
                                guiaDiv.classList.add("hidden")
                                alert("Se ha eliminado la guía.")
                            } else {
                                alert("Error: " + result.error);
                            }
                        } catch (error) {
                            console.error("Error al borrar guía:", error);
                            alert("No se pudo eliminar la guía.");
                        }
                    });
                });

            });
        </script>
    {% endblock %}

{% endif %}
